#!/usr/bin/env ruby

require "thor"
require "json"
require 'dotenv/load'
require 'active_support/all'
require 'representable'
require "pry"

Dir.glob(File.expand_path("../lib/**/*.rb", __dir__)).sort.each do |file|
  require file
end

class Cli < Thor
  desc "import contentful_export_json_file.json", "Import contentful export JSON file"
  method_option :entries, type: :boolean, default: false, desc: "Import entries"
  method_option :assets, type: :boolean, default: false, desc: "Import assets"
  def import(file_name)
    unless File.exist?(file_name)
      puts "Error: File '#{file_name}' not found."
      exit(1)
    end

    begin
      json_data = JSON.parse(File.read(file_name))
      json_data = json_data.deep_transform_keys { |key| key.to_s.underscore }

      if options[:entries]
        EntriesImporter.new.run(json_data.fetch("entries"))
      end

      if options[:assets]
        AssetsImporter.new.run(json_data.fetch("assets"))
      end

    rescue JSON::ParserError => e
      puts "Error parsing JSON: #{e.message}"
      exit(1)
    end
  end
end

Cli.start(ARGV)